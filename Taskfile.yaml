# https://taskfile.dev

version: '3'

vars:
  # Map of clients for each programming language and the path to its executable
  CLIENTS:
    map: {
      go: "./crypto-broker-cli-go/bin/go-client-cli",
      js: "node crypto-broker-cli-js/dist/cli.js"
    }
  # Here are the Known-Answer-Tests for the following text (without quotes): "Welcome CryptoBroker"
  KAT:
    map: {
      KAT_SHA256:
        4a9f3b5a0ad21b75c5cd6ed018167ad9771ad2662756e26f0437c9c7a7cee27a,
      KAT_SHA384:
        b4bba0f7db27f690f11f795f969a539cbf1eee03282979ec1c341a73d66f2316bd180bf8bc1c1fe73cb7684e6073c079,
      KAT_SHA512:
        0d1d495b4dd049d07274d3e4b490dd24136315d4d8bfd83208b48213a0cd57cfa3b2ca3ab2f66cba900de28a5d4ddc4c56d116f518f2a12503c8a9bbe378577a,
      KAT_SHA3_256:
        dbb1a7578253838e60705e19f7f3efc384320515b1398ce7358c12307077c0fe,
      KAT_SHA3_384:
        dfeb2499281d6fd2bf5c6b85d20602d82303b66ad5b6464e68fe680ca67360c317a5c4514c3f5365c71cd557144397e6,
      KAT_SHA3_512:
        14894112f30f982c01e1de386ee9ca60bff70469d9fd249a5f9fbfc66a29c37c76b3fb15c294a6b6d3a1609fa59ca14194e2bc9da16610fa7f1a10dad38d628e,
      }
  # Profiles, CSRs, and Issuer certificates for the SignCertificate tests in the Crypto Broker server
  PROFILES: [
    "Default",
    "KSA-MODERATE-2020",
    "KSA-ADVANCED-2020",
    "FIPS-140-3-Baseline",
    "FIPS-140-3-Medium",
    "FIPS-140-3-Strict"
  ]
  CSR: [
    "csr-rsa-2048",
    "csr-rsa-3072",
    "csr-rsa-4096",
    "csr-rsa-8192",
    "csr-rsa-15380",
    "csr-nist-secp224r1",
    "csr-nist-secp256r1",
    "csr-nist-secp384r1",
    "csr-nist-secp521r1"
  ]
  ISSUER: [
    "test-CA-rsa-3072",
    "test-CA-nist-secp256r1",
    "test-CA-nist-secp384r1",
    "test-CA-nist-secp521r1"
  ]
  # Compatibility matrix file path
  COMP_MATRIX: "testing/compatibility-matrix.md"
  # GNU grep support depending on OS
  GREP_CMD:
    sh: |
      case "$(uname)" in
        Darwin*) echo ggrep ;;
        Linux*) echo grep ;;
      esac

tasks:
  ################# Build Crypto Broker CLI Clients ####################
  # Public build task for the CLI test-clients.
  # At first, an already existing cloned repo will be deleted.
  # Then the repo will be cloned.
  # After that the CLI test-client will be build, language specific tasks are executed.
  build-cli:
    desc: "Build a client depending on the CLI argument with CLIENT='', values: 'go', 'js'. Also the branch can be specified with BRANCH='', values: 'main' (default), 'dev'. The OS and ARCH can also be specified."
    vars:
      BRANCH: '{{.BRANCH | default "main"}}'
      OS: '{{.OS}}'
      ARCH: '{{.ARCH}}'
    requires:
      vars:
        - name: CLIENT
          enum: [go, js]
    cmds:
      - echo "Building {{.CLIENT}} client from branch '{{.BRANCH}}'"
      - task: delete-cli
        vars:
          CLIENT: '{{.CLIENT}}'
      - task: clone-cli
        vars:
          CLIENT: '{{.CLIENT}}'
          BRANCH: '{{.BRANCH}}'
      - task: build-cli-{{.CLIENT}}
        vars:
          OS: '{{.OS}}'
          ARCH: '{{.ARCH}}'

  # Delete the specified cli client
  delete-cli:
    desc: "Delete cli test app source folder depending on the CLI argument with CLIENT='', values: 'go', 'js'"
    requires:
      vars:
        - name: CLIENT
          enum: [go, js]
    cmds:
      - rm -rf crypto-broker-cli-{{.CLIENT}}

  # Internal tasks for building specified CLI test-client
  clone-cli:
    internal: true
    desc: "Clone test app repository"
    cmds:
      # clone the client using a specific branch
      - git clone -b {{.BRANCH}} --single-branch https://github.com/open-crypto-broker/crypto-broker-cli-{{.CLIENT}}.git

  build-cli-go:
    internal: true
    dir: crypto-broker-cli-go
    cmds:
      - GOOS={{.OS}} GOARCH={{.ARCH}} go build -o ./bin/go-client-cli main.go

  build-cli-js:
    internal: true
    dir: crypto-broker-cli-js/
    cmds:
      - npm install

  ################# Build Crypto Broker Server ####################
  # Public build task for Crypto Broker server.
  # At first delete the source folder if it exists.
  # Then the repo will be cloned and the submodules initialized.
  # After that the Crypto Broker will be build.
  build-crypto-broker-server:
    desc: "Clone and build Crypto Broker server. The branch can be specified with BRANCH='', values: 'main' (default), 'dev'. The OS and ARCH can also be specified."
    vars:
      BRANCH: '{{.BRANCH | default "main"}}'
      OS: '{{.OS}}'
      ARCH: '{{.ARCH}}'
    cmds:
      - task: delete-crypto-broker-server
      - task: clone-crypto-broker-server
        vars:
          BRANCH: '{{.BRANCH}}'
      - task: build-crypto-broker-server-internal
        vars:
          OS: '{{.OS}}'
          ARCH: '{{.ARCH}}'

  delete-crypto-broker-server:
    desc: "Delete Crypto Broker server source folder"
    cmds:
      - rm -rf crypto-broker-server

  # Internal tasks for building Crypto Broker server
  clone-crypto-broker-server:
    desc: "Clone Crypto Broker server"
    internal: true
    cmds:
      - git clone -b {{.BRANCH}} --single-branch https://github.com/open-crypto-broker/crypto-broker-server.git
      - task: init-protobuf-crypto-broker-server

  init-protobuf-crypto-broker-server:
    internal: true
    dir: crypto-broker-server/protobuf
    cmds:
      - git submodule update --init

  build-crypto-broker-server-internal:
    internal: true
    status:
      - test -d crypto-broker-server
    dir: crypto-broker-server
    cmds:
      - GOOS={{.OS}} GOARCH={{.ARCH}} go build -o bin/cryptobroker-server cmd/server/server.go

  ################# Cleanup Tasks ####################
  delete-all:
    desc: "Delete the Crypto Broker server and client source folders, the deployment folders, and also the deployment on Cloud Foundry"
    vars:
      ref: .CLIENTS
    cmds:
      - task: delete-crypto-broker-server
      - for: { var: CLIENTS }
        task: delete-cli
        vars:
          CLIENT: '{{.KEY}}'
      - for: { var: CLIENTS }
        task: delete-cf-deployment
        vars:
          CLIENT: '{{.KEY}}'

  ################# End-to-End Tests ####################
  # Public tasks for testing
  test-hash-clis:
    desc: "Build, run and perform hashing tests for all clients. A branch can be specified with BRANCH='', values: 'main' (default), 'dev'. The OS and ARCH can also be specified."
    vars:
      BRANCH: '{{.BRANCH | default "main"}}'
      OS: '{{.OS}}'
      ARCH: '{{.ARCH}}'
    cmds:
      - task: build-dependencies
        vars:
          BRANCH: '{{.BRANCH}}'
          OS: '{{.OS}}'
          ARCH: '{{.ARCH}}'
      - task: start-crypto-broker-server
      - defer: { task: stop-crypto-broker-server }
      - task: test-hashing-clis

  test-sign-clis:
    desc: "Build, run and perform signing tests for all clients. A branch can be specified with BRANCH='', values: 'main' (default), 'dev'. The OS and ARCH can also be specified."
    vars:
      BRANCH: '{{.BRANCH | default "main"}}'
      OS: '{{.OS}}'
      ARCH: '{{.ARCH}}'
      CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
    cmds:
      - task: build-dependencies
        vars:
          BRANCH: '{{.BRANCH}}'
          OS: '{{.OS}}'
          ARCH: '{{.ARCH}}'
      - task: start-crypto-broker-server
      - defer: { task: stop-crypto-broker-server }
      - task: test-sign-certificate-clis
        vars:
          CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'

  test-clis:
    desc: "Combine all tests for all clients in one task. A branch can be specified with BRANCH='', values: 'main' (default), 'dev'. The OS and ARCH can also be specified."
    vars:
      BRANCH: '{{.BRANCH | default "main"}}'
      OS: '{{.OS}}'
      ARCH: '{{.ARCH}}'
    cmds:
      - task: build-dependencies
        vars:
          BRANCH: '{{.BRANCH}}'
          OS: '{{.OS}}'
          ARCH: '{{.ARCH}}'
      - task: start-crypto-broker-server
      - defer: { task: stop-crypto-broker-server }
      - task: test-hashing-clis
      - task: test-sign-certificate-clis

  # Tasks for installing/removing GNU grep on macOS
  macos-install-gnu-grep:
    desc: "Install GNU grep on macOS"
    platforms: ["darwin"]
    cmds:
      - brew install grep

  macos-remove-gnu-grep:
    desc: "Remove GNU grep from macOS"
    platforms: ["darwin"]
    cmds:
      - brew uninstall grep

  # Internal tasks for end-to-end tests
  # Build Crypto Broker server and the clients for end-to-end tests
  build-dependencies:
    desc: "Build all dependencies: clients and server, depending on the specified branch"
    internal: true
    vars:
      ref: .CLIENTS
    cmds:
      - task: build-crypto-broker-server
        vars:
          BRANCH: '{{.BRANCH}}'
          OS: '{{.OS}}'
          ARCH: '{{.ARCH}}'
      - for: { var: CLIENTS }
        task: build-cli
        vars:
          CLIENT: '{{.KEY}}'
          CLIENT_PATH: '{{.ITEM}}'
          BRANCH: '{{.BRANCH}}'
          OS: '{{.OS}}'
          ARCH: '{{.ARCH}}'

  # Start/Stop Crypto Broker server
  start-crypto-broker-server:
    desc: "Start the Crypto Broker Server with a custom test profile"
    internal: true
    cmds:
      - CRYPTO_BROKER_PROFILES_DIR=$PWD/testing/profiles ./crypto-broker-server/bin/cryptobroker-server &

  stop-crypto-broker-server:
    desc: "Stop the Crypto Broker Server after all tests were executed"
    internal: true
    cmds:
      - kill $(ps -e | awk '/cryptobroker/ {print $1}')

  # Hashing tests from the clients
  test-hashing-clis:
    desc: "Iterate hashing tests over all clients"
    internal: true
    vars:
      CLIENTS:
        ref: .CLIENTS
    cmds:
      - for: { var: CLIENTS }
        task: test-hashing-KATs
        vars:
          CLIENT_PATH: '{{.ITEM}}'

  test-hashing-KATs:
    desc: "Iterate over all hashing KATs"
    internal: true
    vars:
      KAT:
        ref: .KAT
    cmds:
      - for: { var: KAT }
        cmd:
          |
          echo "Test {{.KEY}}"
          HASH_RESPONSE=$({{.CLIENT_PATH}} --profile={{.KEY}} hash "Welcome CryptoBroker" | {{.GREP_CMD}} -oP '\"hashValue\":\s?"\K[^"]+')
          if [[ $HASH_RESPONSE != {{.ITEM}} ]] then
            echo "Error: Hash values do not match!"
            exit 1
          fi

  # Sign certificate tests from the clients
  test-sign-certificate-clis:
    desc: "Iterate signing tests over all clients"
    internal: true
    silent: true
    vars:
      CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
      CLIENTS:
        ref: .CLIENTS
    cmds:
        # Delete previous compatibility matrix
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        rm {{.COMP_MATRIX}}
        {{end}}
      # Create header for compatibility matrix
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "# Clients Compatibility Matrix\n\n" >> {{.COMP_MATRIX}}
        {{end}}
      - for: { var: CLIENTS }
        task: test-sign-iterate-profiles
        vars:
          CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
          CLIENT: '{{.KEY}}'
          CLIENT_PATH: '{{.ITEM}}'
      # Remove duplicate newline at EOF (otherwise Markdownlint will complain)
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        truncate -s -1 {{.COMP_MATRIX}}
        {{end}}

  test-sign-iterate-profiles:
    desc: "Iterate over each profile"
    internal: true
    silent: true
    vars:
      CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
      PROFILES:
        ref: .PROFILES
    cmds:
      # Add header for each client
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "## {{.CLIENT | title}} Client\n\n" >> {{.COMP_MATRIX}}
        {{end}}
      - for: { var: PROFILES }
        task: test-sign-iterate-issuer
        vars:
          CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
          CLIENT_PATH: '{{.CLIENT_PATH}}'
          PROFILE: '{{.ITEM}}'

  test-sign-iterate-issuer:
    desc: "Iterate over each CA-issuer certificate and key"
    internal: true
    silent: true
    vars:
      CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
      CSR:
        ref: .CSR
      ISSUER:
        ref: .ISSUER
    cmds:
      - task: comp-matrix-create-header-row
        vars:
          CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
          CSR:
            ref: .CSR
          PROFILE: '{{.PROFILE}}'
      ### Fill the table
      # Iterate for each issuer CA and key over each CSR
      - for: { var: ISSUER }
        task: test-sign-iterate-csr
        vars:
          CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
          CLIENT_PATH: '{{.CLIENT_PATH}}'
          PROFILE: '{{.PROFILE}}'
          ISSUER: '{{.ITEM}}'
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "\n" >> {{.COMP_MATRIX}}
        {{end}}

  comp-matrix-create-header-row:
    desc: "Create header rows for the compatibility matrix"
    internal: true
    silent: true
    vars:
      PROFILE: '{{.PROFILE}}'
      CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
      CSR:
        ref: .CSR
    cmds:
      ### Add header for each profile
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "### Profile \"{{.PROFILE}}\"\n\n" >> {{.COMP_MATRIX}}
        {{end}}
      ### Header row generation
      # First cell of header row
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "| Issuer↓ \ CSR➔ | " >> {{.COMP_MATRIX}}
        {{end}}
      # Create the rest of the header row for the compatibility matrix
      - for: { var: CSR }
        cmd:
          |
          {{if eq .CREATE_COMP_MATRIX "true"}}
          printf " {{.ITEM | upper}} |" >> {{.COMP_MATRIX}}
          {{end}}
      # Add newline at end of header row
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "\n" >> {{.COMP_MATRIX}}
        {{end}}
      ### Markdown specific second row
      # First cell of the second row
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "| --- | " >> {{.COMP_MATRIX}}
        {{end}}
      # Create the rest of the second row with center alignment
      - for: { var: CSR }
        cmd: |
          {{if eq .CREATE_COMP_MATRIX "true"}}
          printf " :---: |" >> {{.COMP_MATRIX}}
          {{end}}
      # Add newline at end of second row
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "\n" >> {{.COMP_MATRIX}}
        {{end}}

  test-sign-iterate-csr:
    desc: "Iterate over each CSR"
    internal: true
    silent: true
    vars:
      CREATE_COMP_MATRIX: '{{.CREATE_COMP_MATRIX}}'
      CSR:
        ref: .CSR
    cmds:
      # First cell in each row: Issuer key size
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "| {{.ISSUER | upper}} |" >> {{.COMP_MATRIX}}
        {{end}}
      - for: { var: CSR }
        cmd: |
          TEST_CA_DIR=testing/certificates/test-ca
          TEST_CSR_DIR=testing/certificates/test-csr
          {{if ne .CREATE_COMP_MATRIX "true"}}
          printf "Testing SignCertificate API\nProfile: \"{{.PROFILE}}\"\nCSR: \"{{.ITEM}}\"\nIssuer: \"{{.ISSUER}}\"\n"
          {{end}}
          RESPONSE=$({{.CLIENT_PATH}} --profile={{.PROFILE}} sign --csr=$TEST_CSR_DIR/{{.ITEM}}.csr --caCert=$TEST_CA_DIR/cert-{{.ISSUER}}.pem --caKey=$TEST_CA_DIR/{{.ISSUER}}.pem)
          if echo "$RESPONSE" | {{.GREP_CMD}} -E 'Sign [Rr]esponse'; then
            {{if eq .CREATE_COMP_MATRIX "true"}}
            printf " ✅ |" >> {{.COMP_MATRIX}}
            {{else}}
            echo "✅ Supported"
            {{end}}
          else
            {{if eq .CREATE_COMP_MATRIX "true"}}
            printf " ❌ |" >> {{.COMP_MATRIX}}
            {{else}}
            echo "❌ Not supported"
            {{end}}
          fi
      - |
        {{if eq .CREATE_COMP_MATRIX "true"}}
        printf "\n" >> {{.COMP_MATRIX}}
        {{end}}

  # Test custom subject feature
  test-sign-certificate-clis-custom-subject:
    desc: "Iterate signing tests over all clients with a custom subject"
    vars:
      ref: .CLIENTS
    cmds:
      - for: { var: CLIENTS }
        task: test-sign-certificate-custom-subject
        vars:
          CLIENT_PATH: '{{.ITEM}}'

  test-sign-certificate-custom-subject:
    desc: "Test custom subject with CLI API"
    internal: true
    cmds:
      - |
        echo "Test custom subject with CLI API"
        TMP_DIR=tmp/certificate-responses/subject
        TEST_CA_DIR=testing/certificates/test-ca
        TEST_CSR_DIR=testing/certificates/test-csr
        rm -rf $TMP_DIR
        mkdir -p $TMP_DIR
        SIGNED_CERTIFICATE=$({{.CLIENT_PATH}} --profile=Default sign --csr=$TEST_CSR_DIR/csr-nist-secp384r1.csr --caCert=$TEST_CA_DIR/cert-test-CA-nist-secp521r1.pem --caKey=$TEST_CA_DIR/test-CA-nist-secp521r1.pem --subject="C=DE, O=Test Org, OU=Test Certificate Service, OU=Dev, OU=Staging-certificate-service, L=test, CN=test" | {{.GREP_CMD}} -oP '\"signedCertificate\":\s?"\K[^"]+')
        printf "$SIGNED_CERTIFICATE" > $TMP_DIR/tmp-cert-custom-subject.pem
        openssl x509 -inform PEM -in $TMP_DIR/tmp-cert-custom-subject.pem -text

  ################# Cloud Foundry Deployment ####################
  # Public tasks for Cloud Foundry deployment
  # The deployment is done over several stages.
  # First, the old deployment folder is deleted.
  # Second, the Crypto Broker server is build.
  # Third, the specified client is build.
  # Fourth, the deployment repo is created.
  # Fifth, the necessary files from the Crypto Broker are copied to the deployment folder.
  # Sixth, the necessary files from the client are copied to the deployment folder.
  # Seventh, the cf CLI is invoked and the app is pushed to Cloud Foundry.
  deploy-cf-cryptobroker:
    desc: "Deploy to Cloud Foundry the Crypto Broker server and client specified with CLIENT='', values are 'go', 'js'. A branch can be specified with BRANCH='', values: 'main' (default), 'dev'"
    vars:
      BRANCH: '{{.BRANCH | default "main"}}'
    requires:
      vars:
        - name: CLIENT
          enum: [go, js]
    cmds:
      - task: delete-deployment-folder
        vars:
          CLIENT: '{{.CLIENT}}'
      - task: build-crypto-broker-server
        vars:
          BRANCH: '{{.BRANCH}}'
      - task: build-cli
        vars:
          CLIENT: '{{.CLIENT}}'
          BRANCH: '{{.BRANCH}}'
      - task: create-deployment-folder
        vars:
          CLIENT: '{{.CLIENT}}'
      - task: copy-crypto-broker-server
        vars:
          CLIENT: '{{.CLIENT}}'
      - task: copy-test-certificates
        vars:
          CLIENT: '{{.CLIENT}}'
      - task: copy-{{.CLIENT}}-cli
      - cf push --random-route -f deployments/cloud-foundry/{{.CLIENT}}/manifest.yaml -p deployments/cloud-foundry/{{.CLIENT}}/{{.CLIENT}}-deployment/

  delete-cf-deployment:
    desc: "Delete the deployment folders and also on Cloud Foundry the deployment of Crypto Broker server and the specified client with CLIENT='', values are 'go', 'js'"
    requires:
      vars:
        - name: CLIENT
          enum: [go, js]
    cmds:
        - task: delete-deployment-folder
          vars:
            CLIENT: '{{.CLIENT}}'
        - cf delete -r -f crypto-broker-{{.CLIENT}}-cli

  # Internal tasks for deployment to Cloud Foundry
  create-deployment-folder:
    desc: "Create the deployment folder for Cloud Foundry"
    internal: true
    cmds:
      - mkdir deployments/cloud-foundry/{{.CLIENT}}/{{.CLIENT}}-deployment

  delete-deployment-folder:
    desc: "Delete the deployment folder for Cloud Foundry"
    internal: true
    cmds:
      - rm -rf deployments/cloud-foundry/{{.CLIENT}}/{{.CLIENT}}-deployment

  copy-crypto-broker-server:
    desc: "Copy Crypto Broker server files to deployment folder"
    internal: true
    cmds:
      - cp crypto-broker-server/bin/cryptobroker-server deployments/cloud-foundry/{{.CLIENT}}/{{.CLIENT}}-deployment/
      - cp testing/profiles/Profiles.yaml deployments/cloud-foundry/{{.CLIENT}}/{{.CLIENT}}-deployment/

  copy-test-certificates:
    desc: "Copy test CSR and test CA certificate and CA private key to Cloud Foundry"
    internal: true
    cmds:
      - cp -r testing/certificates deployments/cloud-foundry/{{.CLIENT}}/{{.CLIENT}}-deployment/

  # Go specific task
  copy-go-cli:
    desc: "Copy the necessary Go client files for Cloud Foundry deployment"
    internal: true
    cmds:
      - cp crypto-broker-cli-go/bin/go-client-cli deployments/cloud-foundry/go/go-deployment

  # Node.js specific tasks
  copy-js-cli:
    desc: "Copy the necessary Node.js client files for Cloud Foundry deployment"
    internal: true
    cmds:
      - cp crypto-broker-cli-js/package*.json deployments/cloud-foundry/js/js-deployment/
      - cp -r crypto-broker-cli-js/dist deployments/cloud-foundry/js/js-deployment/
      - task: init-node-modules

  init-node-modules:
    internal: true
    dir: deployments/cloud-foundry/js/js-deployment
    cmds:
      - npm ci --omit=dev --ignore-scripts

  ################# Kubernetes Deployment ####################
  minikube-images:
    desc: "Load the docker images into minikube (Note: this might take a while)"
    cmds:
      - minikube image load ghcr.io/open-crypto-broker/test_app_js ghcr.io/open-crypto-broker/test_app_go ghcr.io/open-crypto-broker/server

  kube-deploy:
    desc: "Deploys the Kubernetes Crypto Broker"
    dir: deployments/k8s/kube-broker/
    cmds:
      - helm install -f Chart.yaml -f values.yaml crypto-broker --namespace crypto-broker --create-namespace .

  kube-destroy:
    desc: "Destroys the Kubernetes Crypto Broker deployment"
    cmds:
      - helm uninstall crypto-broker -n crypto-broker

  ################# Docker-Compose Deployment ####################
  docker-compose-build:
    desc: "Build docker images"
    dir: deployments/docker/
    vars:
      BRANCH: '{{.BRANCH | default "main"}}'
    cmds:
      - task: build-dependencies
        vars:
          BRANCH: '{{.BRANCH}}'
      - docker compose -f server.yml -f test_app_js.yml -f test_app_go.yml build

  docker-compose-deploy:
    desc: "Deploy docker images with docker compose (you can optionally specify an image tag with TAG=...)"
    vars:
      BRANCH: '{{.BRANCH | default "latest"}}'
    dir: deployments/docker/
    cmds:
      - TAG={{.TAG}} docker compose -f server.yml -f test_app_js.yml -f test_app_go.yml up
